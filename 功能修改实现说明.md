# Obsidian Local GPT 功能修改实现说明

## 已实现的功能修改

### 1. ✅ 跨会话保存模型选择
- **实现方式**：通过 `@` 选择的模型会直接更新到全局配置 `settings.aiProviders.main` 或 `settings.aiProviders.vision`
- **持久化**：调用 `this.plugin.saveSettings()` 保存到配置文件
- **效果**：用户切换笔记后，之前选择的模型依然生效

### 2. ✅ 模型选择面板分组显示
- **界面布局**：
  ```
  ━━━━━ 主模型 ━━━━━
  - 主模型1 ✓
  - 主模型2
  ━━━━━ 视觉模型 ━━━━━
  - GPT-4 Vision
  - Claude 3
  ```
- **自动分类**：根据模型能力和名称自动区分主模型和视觉模型
- **当前选中标记**：已选中的模型会显示 ✓ 标记
- **无分隔线**：主模型和视觉模型之间无需分隔线，标题已足够区分

### 3. ✅ 模型名称自动补全
- **实现效果**：选择模型后，编辑器中显示 `@模型名称 `
- **补全逻辑**：使用 `editor.replaceRange()` 替换原始的 `@` 触发文本

### 4. ✅ 功能菜单触发改进
- **新触发符号**：中文冒号 `：`
- **支持模糊搜索**：`：翻译` 可快速筛选包含"翻译"的功能
- **自动删除**：选择功能后，`：` 符号会被自动删除

### 5. ✅ 取消模型选择前置条件
- **原逻辑**：必须先通过 `@` 选择模型才能使用 `::`
- **新逻辑**：直接输入 `：` 即可唤起功能菜单，使用配置中的默认模型

### 6. ✅ 输出格式优化
- **模型名称显示**：
  ```
  [模型名称 (具体型号)] 2024/1/10 15:30:45:
  AI生成的内容
  ```
- **换行显示**：模型名称和时间戳在第一行，内容从新行开始
- **时间戳**：添加中文格式的时间戳（上海时区）

### 7. ✅ 性能指标格式优化
- **新格式**：
  ```
  [Tokens: 177 ↑16 ↓155 66tokens/s | 首字延迟: xxx ms | 总耗时: xxx ms]:
  ```
- **格式统一**：使用方括号 `[]` 包裹，末尾保留冒号 `:`
- **指标说明**：
  - `177`：总 Token 数
  - `↑16`：输入 Token 数
  - `↓155`：输出 Token 数
  - `66tokens/s`：生成速度

### 8. ✅ 智能模型匹配
- **匹配算法**：
  - 完全匹配：100分
  - 开头匹配：80分
  - 包含匹配：50分
- **最佳匹配优先**：将匹配分数最高的模型移到对应分组的第一位
- **提升用户体验**：输入部分名称即可快速定位到目标模型

### 9. ✅ Token 消耗统计
- **多源数据获取**：从 `metadata`、`chunkHandler.usage` 等多个可能的来源获取 token 数据
- **兼容多种格式**：支持 `prompt_tokens`、`promptTokens`、`inputTokens` 等多种命名格式
- **智能计算**：当无法获取实际数据时显示 "?"，有数据时自动计算总数和速率
- **调试日志**：记录实际返回的数据结构，便于后续优化

## 代码改动总结

### 1. **ActionSuggestor 类**
- 修改触发条件：从 `::` 改为 `：`
- 移除模型选择前置检查
- 添加模糊匹配功能

### 2. **ModelSuggestor 类**
- 实现分组显示逻辑
- 添加模型名称补全功能
- 根据模型类型更新对应的全局配置
- 添加当前选中模型的标记显示

### 3. **LocalGPT 主类**
- 移除临时模型存储相关的属性和方法
- 简化 `runAction` 方法，直接使用全局配置的模型

### 4. **输出格式**
- 模型名称换行显示
- 性能指标格式更新

## 注意事项

1. **Token 计数**：目前使用模拟数据（177/16/155），需要后续集成实际的 Token 计数功能
2. **视觉模型判断**：基于模型名称和能力属性，可能需要根据实际模型调整判断逻辑
3. **性能指标**：`tokens/s` 的计算基于模拟数据，实际使用时需要根据真实的 Token 数计算
4. **类型安全**：IAIProvider 接口可能不包含 `capabilities` 属性，代码中使用了类型断言 `as any` 来安全访问该属性 